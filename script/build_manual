#!/bin/sh

set -e

export GIT_BRANCH=$(git branch -a -v --abbrev=40 | grep $(git rev-parse HEAD) | awk '{print $1}' | grep -v '*' | head -n1 | awk -F '/' '{print $NF}')
export GIT_VERSION=$(git describe --tags)

set -x

if [ -z $CI ]; then
    IMAGE=emacs-docs
else
    IMAGE=${CI_REGISTRY_IMAGE}_emacs-docs:${CI_COMMIT_SHA}
fi

docker build -t $IMAGE ./doc
docker run --rm -v "${DOCKER_PWD:-$PWD}/doc:/workspace" -e GIT_BRANCH -e GIT_VERSION $IMAGE
rm -f doc/htmls.tgz

mkdir -p ./reports/manual
mv -f ./doc/*.html ./reports/manual/
cp -rf ./doc/css ./doc/fonts ./doc/images ./doc/js ./reports/manual/
